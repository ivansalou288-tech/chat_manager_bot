<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≤ –ú–æ–¥—É–ª—å Cubes (–î—É—ç–ª—å –Ω–∞ –∫—É–±–∏–∫–∞—Ö) - –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 40px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .breadcrumb {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            font-size: 0.9em;
            color: #666;
        }

        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .content {
            padding: 40px;
        }

        .content h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .content h2 {
            color: #764ba2;
            font-size: 1.6em;
            margin-top: 30px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            padding-left: 15px;
        }

        .content h3 {
            color: #667eea;
            font-size: 1.3em;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .content h4 {
            color: #764ba2;
            font-size: 1.1em;
            margin-top: 15px;
            margin-bottom: 8px;
        }

        .content p {
            line-height: 1.8;
            margin: 15px 0;
            color: #444;
        }

        .content ul, .content ol {
            margin: 15px 0;
            margin-left: 30px;
            line-height: 1.8;
        }

        .content li {
            margin: 8px 0;
            color: #444;
        }

        .content code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #d63384;
            font-size: 0.95em;
        }

        .content pre {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }

        .content pre code {
            color: #333;
            padding: 0;
            background: none;
            font-size: 0.9em;
        }

        .content blockquote {
            border-left: 4px solid #667eea;
            padding-left: 20px;
            margin: 20px 0;
            color: #666;
            font-style: italic;
        }

        .content a {
            color: #667eea;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: all 0.3s ease;
        }

        .content a:hover {
            border-bottom-color: #667eea;
        }

        .content table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .content table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
        }

        .content table td {
            border: 1px solid #ddd;
            padding: 12px;
        }

        .content table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .content hr {
            border: none;
            border-top: 2px solid #667eea;
            margin: 30px 0;
        }

        .content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 20px 0;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
            justify-content: space-between;
        }

        .nav-button {
            display: inline-block;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .nav-button:hover {
            background: #764ba2;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .nav-button.prev {
            margin-right: auto;
        }

        footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #ddd;
            color: #666;
            font-size: 0.9em;
        }

        footer a {
            color: #667eea;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .content {
                padding: 20px;
            }

            .nav-buttons {
                flex-direction: column;
            }

            .nav-button.prev {
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé≤ –ú–æ–¥—É–ª—å Cubes (–î—É—ç–ª—å –Ω–∞ –∫—É–±–∏–∫–∞—Ö) - –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤</h1>
            <p style="opacity: 0.9; font-size: 1.1em;">Chat Manager Bot - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</p>
        </header>

        <div class="breadcrumb">
            <a href="../html/index.html">üè† –ì–ª–∞–≤–Ω–∞—è</a> / 
            <a href="../html/index_site.html">üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</a> / 
            <span>üé≤ –ú–æ–¥—É–ª—å Cubes (–î—É—ç–ª—å –Ω–∞ –∫—É–±–∏–∫–∞—Ö) - –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤</span>
        </div>

        <div class="content">
            
<p><strong>–í–µ—Ä—Å–∏—è:</strong> 1.0<br />
<strong>–î–∞—Ç–∞:</strong> 20.12.2025<br />
<strong>–°—Ç–∞—Ç—É—Å:</strong> ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ production<br />
<strong>–Ø–∑—ã–∫:</strong> Python 3.10+  </p>
<hr />
<h2>üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</h2>
<ol>
<li><a href="#–æ–±–∑–æ—Ä">–û–±–∑–æ—Ä</a></li>
<li><a href="#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞">–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞</a></li>
<li><a href="#api-—Å–∏—Å—Ç–µ–º—ã-–¥—É—ç–ª–µ–π">API —Å–∏—Å—Ç–µ–º—ã –¥—É—ç–ª–µ–π</a></li>
<li><a href="#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–±–∞–∑—ã-–¥–∞–Ω–Ω—ã—Ö">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</a></li>
<li><a href="#–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏-—Å–æ–æ–±—â–µ–Ω–∏–π">–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</a></li>
<li><a href="#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è">–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</a></li>
<li><a href="#–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è</a></li>
<li><a href="#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</a></li>
<li><a href="#—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ-—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏">–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏</a></li>
</ol>
<hr />
<h2>üìñ –û–±–∑–æ—Ä</h2>
<p>–ú–æ–¥—É–ª—å Cubes (<code>modules/cubes.py</code>) —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Å–∏—Å—Ç–µ–º—É –¥—É—ç–ª–µ–π –º–µ–∂–¥—É –¥–≤—É–º—è –∏–≥—Ä–æ–∫–∞–º–∏ –Ω–∞ –∫—É–±–∏–∫–∞—Ö. –û–¥–∏–Ω –∏–≥—Ä–æ–∫ –≤—ã–∑—ã–≤–∞–µ—Ç –¥—Ä—É–≥–æ–≥–æ –Ω–∞ –¥—É—ç–ª—å, –≤—ã–∑–≤–∞–Ω–Ω—ã–π –º–æ–∂–µ—Ç —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è –∏–ª–∏ –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è, –∞ –∑–∞—Ç–µ–º –∫—É–±–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –ø–æ–±–µ–¥–∏—Ç–µ–ª—è. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ç–∞–≤–∫–∏ –Ω–∞ –∫–æ–∏–Ω—ã –∏–∑ —Ñ–∞—Ä–º—ã.</p>
<h3>–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</h3>
<p>‚úÖ <strong>–°–∏—Å—Ç–µ–º–∞ –≤—ã–∑–æ–≤–æ–≤</strong> - –æ–¥–∏–Ω –∏–≥—Ä–æ–∫ –≤—ã–∑—ã–≤–∞–µ—Ç –¥—Ä—É–≥–æ–≥–æ –Ω–∞ –¥—É—ç–ª—å<br />
‚úÖ <strong>–í—Ä–µ–º—è –Ω–∞ –æ—Ç–≤–µ—Ç</strong> - 90 —Å–µ–∫—É–Ω–¥ —á—Ç–æ–±—ã —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è –∏–ª–∏ –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è<br />
‚úÖ <strong>–°—Ç–∞–≤–∫–∏</strong> - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–≥—Ä–∞—Ç—å –Ω–∞ –∫–æ–∏–Ω—ã –∏–∑ –º–µ—à–∫–∞<br />
‚úÖ <strong>–ë—Ä–æ—Å–∫–∏ –∫—É–±–∏–∫–æ–≤</strong> - —Å–ª—É—á–∞–π–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞<br />
‚úÖ <strong>–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è</strong> - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º<br />
‚úÖ <strong>–ü–µ—Ä–µ–¥–∞—á–∞ –∫–æ–∏–Ω–æ–≤</strong> - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –≤—ã–∏–≥—Ä—ã—à–∞/–ø—Ä–æ–∏–≥—Ä—ã—à–∞<br />
‚úÖ <strong>–ò—Å—Ç–æ—Ä–∏—è –¥—É—ç–ª–µ–π</strong> - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤  </p>
<hr />
<h2>üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞</h2>
<h3>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è</h3>
<pre class="codehilite"><code>modules/cubes.py
‚îú‚îÄ‚îÄ –ö–ª–∞—Å—Å _CubesDuel
‚îÇ   ‚îú‚îÄ‚îÄ duel_id: str
‚îÇ   ‚îú‚îÄ‚îÄ chat_id: int
‚îÇ   ‚îú‚îÄ‚îÄ inviter_id: int
‚îÇ   ‚îú‚îÄ‚îÄ opponent_id: int
‚îÇ   ‚îú‚îÄ‚îÄ inviter_name: str
‚îÇ   ‚îú‚îÄ‚îÄ opponent_name: str
‚îÇ   ‚îú‚îÄ‚îÄ invite_message_id: int
‚îÇ   ‚îú‚îÄ‚îÄ created_at: float
‚îÇ   ‚îî‚îÄ‚îÄ stake: int
‚îÇ
‚îú‚îÄ‚îÄ –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥—É—ç–ª–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ _PENDING_BY_CHAT[chat_id] -&gt; duel_id
‚îÇ   ‚îî‚îÄ‚îÄ _PENDING_BY_ID[duel_id] -&gt; _CubesDuel
‚îÇ
‚îú‚îÄ‚îÄ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ cubes_handler() - –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –¥—É—ç–ª—å
‚îÇ   ‚îú‚îÄ‚îÄ accept_duel_handler() - —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è —Å –¥—É—ç–ª—å—é
‚îÇ   ‚îú‚îÄ‚îÄ reject_duel_handler() - –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –¥—É—ç–ª—å
‚îÇ   ‚îî‚îÄ‚îÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏—Å—Ç—ë–∫—à–∏—Ö –¥—É—ç–ª–µ–π
‚îÇ
‚îî‚îÄ‚îÄ –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    ‚îú‚îÄ‚îÄ _user_link() - —Å–æ–∑–¥–∞–Ω–∏–µ HTML-—Å—Å—ã–ª–∫–∏ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    ‚îú‚îÄ‚îÄ _is_expired() - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –¥—É—ç–ª–∏
    ‚îú‚îÄ‚îÄ _parse_stake() - –ø–∞—Ä—Å–∏–Ω–≥ —Ä–∞–∑–º–µ—Ä–∞ —Å—Ç–∞–≤–∫–∏
    ‚îî‚îÄ‚îÄ _ensure_farma_row_and_get_meshok() - –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
</code></pre>

<h3>–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö</h3>
<pre class="codehilite"><code>–ò–≥—Ä–æ–∫ A –ø–∏—à–µ—Ç &quot;!–∫—É–±—ã 100&quot; –¥–ª—è –≤—ã–∑–æ–≤–∞ B
         ‚Üì
    cubes_handler()
         ‚Üì
    –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ _CubesDuel
         ‚Üì
    –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ _PENDING_BY_ID –∏ _PENDING_BY_CHAT
         ‚Üì
    –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–∞–º–∏ —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è/–æ—Ç–∫–∞–∑–∞—Ç—å—Å—è
         ‚Üì
    90 —Å–µ–∫—É–Ω–¥ –æ–∂–∏–¥–∞–Ω–∏—è –Ω–∞ –æ—Ç–≤–µ—Ç
         ‚Üì
    [–ò–≥—Ä–æ–∫ B —Å–æ–≥–ª–∞—Å–∏–ª—Å—è] –ò–õ–ò [–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ]
         ‚Üì
    –†–æ–∑—ã–≥—Ä—ã—à –∫—É–±–∏–∫–æ–≤
         ‚Üì
    –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
         ‚Üì
    –ü–µ—Ä–µ–¥–∞—á–∞ –∫–æ–∏–Ω–æ–≤
         ‚Üì
    –£–¥–∞–ª–µ–Ω–∏–µ –¥—É—ç–ª–∏ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
</code></pre>

<hr />
<h2>üîå API —Å–∏—Å—Ç–µ–º—ã –¥—É—ç–ª–µ–π</h2>
<h3>_CubesDuel</h3>
<p>–ö–ª–∞—Å—Å –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥—É—ç–ª–∏.</p>
<pre class="codehilite"><code class="language-python">@dataclass
class _CubesDuel:
    duel_id: str              # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥—É—ç–ª–∏
    chat_id: int              # ID —á–∞—Ç–∞, –≥–¥–µ –∏–¥—ë—Ç –¥—É—ç–ª—å
    inviter_id: int           # ID –ø—Ä–∏–≥–ª–∞—à–∞—é—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
    opponent_id: int          # ID –≤—ã–∑–≤–∞–Ω–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    inviter_name: str         # –ò–º—è –ø—Ä–∏–≥–ª–∞—à–∞—é—â–µ–≥–æ
    opponent_name: str        # –ò–º—è –≤—ã–∑–≤–∞–Ω–Ω–æ–≥–æ
    invite_message_id: int    # ID —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ–º
    created_at: float         # –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è)
    stake: int                # –°—Ç–∞–≤–∫–∞ –≤ –∫–æ–∏–Ω–∞—Ö
</code></pre>

<h3>_PENDING_BY_CHAT –∏ _PENDING_BY_ID</h3>
<p>–ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥—É—ç–ª–µ–π.</p>
<pre class="codehilite"><code class="language-python">_PENDING_BY_CHAT: dict[int, str] = {}  # chat_id -&gt; duel_id
_PENDING_BY_ID: dict[str, _CubesDuel] = {}  # duel_id -&gt; _CubesDuel
</code></pre>

<h3>_parse_stake()</h3>
<p>–§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ä–∞–∑–º–µ—Ä–∞ —Å—Ç–∞–≤–∫–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∫–æ–º–∞–Ω–¥—ã.</p>
<pre class="codehilite"><code class="language-python">def _parse_stake(text: str) -&gt; Optional[int]:
    &quot;&quot;&quot;
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
      - &quot;!–∫—É–±—ã 100&quot;
      - &quot;! –∫—É–±—ã 100&quot;
      - –±–µ–∑ —Å—Ç–∞–≤–∫–∏ -&gt; 100 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    &quot;&quot;&quot;
</code></pre>

<p><strong>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:</strong>
- <code>text</code> (str): –¢–µ–∫—Å—Ç –∫–æ–º–∞–Ω–¥—ã</p>
<p><strong>–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:</strong> 
- <code>int</code> - —Ä–∞–∑–º–µ—Ä —Å—Ç–∞–≤–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 100)
- <code>None</code> - –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π</p>
<p><strong>–ü—Ä–∏–º–µ—Ä—ã:</strong></p>
<pre class="codehilite"><code class="language-python">_parse_stake(&quot;!–∫—É–±—ã 100&quot;)     # -&gt; 100
_parse_stake(&quot;! –∫—É–±—ã 50&quot;)     # -&gt; 50
_parse_stake(&quot;!–∫—É–±—ã&quot;)         # -&gt; 100 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
_parse_stake(&quot;!–∫—É–±—ã abc&quot;)     # -&gt; None
</code></pre>

<h3>_ensure_farma_row_and_get_meshok()</h3>
<p>–§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–æ–∑–¥–∞–Ω–∏–µ–º –∑–∞–ø–∏—Å–∏.</p>
<pre class="codehilite"><code class="language-python">def _ensure_farma_row_and_get_meshok(cursor: sqlite3.Cursor, user_id: int) -&gt; int:
    &quot;&quot;&quot;
    –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ farma –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–∞–ª–∞–Ω—Å
    &quot;&quot;&quot;
</code></pre>

<p><strong>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:</strong>
- <code>cursor</code> (sqlite3.Cursor): –ö—É—Ä—Å–æ—Ä –ë–î
- <code>user_id</code> (int): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</p>
<p><strong>–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:</strong> 
- <code>int</code> - —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –º–µ—à–∫–∞ (–∏–ª–∏ 0 –µ—Å–ª–∏ –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)</p>
<h3>cubes_handler()</h3>
<p>–û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏—è –¥—É—ç–ª–∏.</p>
<pre class="codehilite"><code class="language-python">@dp.message_handler(Text(startswith=['! –∫—É–±—ã', '!–∫—É–±—ã'], ignore_case=True))
async def cubes_handler(message: types.Message):
    &quot;&quot;&quot;
    –ò–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –¥—É—ç–ª—å –º–µ–∂–¥—É –¥–≤—É–º—è –∏–≥—Ä–æ–∫–∞–º–∏ –Ω–∞ –∫—É–±–∏–∫–∞—Ö
    &quot;&quot;&quot;
</code></pre>

<p><strong>–°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–≥–¥–∞:</strong>
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—à–µ—Ç <code>!–∫—É–±—ã</code> –∏–ª–∏ <code>! –∫—É–±—ã</code> —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π —Å—Ç–∞–≤–∫–æ–π</p>
<p><strong>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:</strong>
- <code>message.from_user.id</code> (int): ID –ø—Ä–∏–≥–ª–∞—à–∞—é—â–µ–≥–æ
- <code>message.reply_to_message</code> (optional): –ï—Å–ª–∏ –¥—É—ç–ª—å –ø–æ –æ—Ç–≤–µ—Ç—É –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
- <code>message.text</code> (str): –¢–µ–∫—Å—Ç –∫–æ–º–∞–Ω–¥—ã, —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–∞–∑–º–µ—Ä —Å—Ç–∞–≤–∫–∏</p>
<p><strong>–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:</strong> None (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç)</p>
<p><strong>–õ–æ–≥–∏–∫–∞:</strong>
1. –ü–æ–ª—É—á–∞–µ—Ç —Ü–µ–ª–µ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞ (–∏–∑ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)
2. –ü–∞—Ä—Å–∏—Ç —Ä–∞–∑–º–µ—Ä —Å—Ç–∞–≤–∫–∏
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å –æ–±–æ–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
4. –°–æ–∑–¥–∞—ë—Ç –æ–±—ä–µ–∫—Ç _CubesDuel
5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è/–æ—Ç–∫–∞–∑–∞—Ç—å—Å—è
6. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–∞–π–º–µ—Ä –Ω–∞ 90 —Å–µ–∫—É–Ω–¥
7. –ü—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —É–¥–∞–ª—è–µ—Ç –¥—É—ç–ª—å</p>
<hr />
<h2>üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h2>
<h3>–¢–∞–±–ª–∏—Ü–∞ <code>farma</code></h3>
<pre class="codehilite"><code class="language-sql">CREATE TABLE IF NOT EXISTS farma (
    user_id INTEGER PRIMARY KEY,
    meshok INTEGER DEFAULT 0,
    last_date TEXT
)
</code></pre>

<h3>–¢–∞–±–ª–∏—Ü–∞ <code>duels</code> (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏)</h3>
<pre class="codehilite"><code class="language-sql">CREATE TABLE IF NOT EXISTS duels (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    chat_id INTEGER NOT NULL,
    inviter_id INTEGER NOT NULL,
    opponent_id INTEGER NOT NULL,
    winner_id INTEGER NOT NULL,
    stake INTEGER NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
</code></pre>

<h3>–ü—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö</h3>
<pre class="codehilite"><code class="language-sql">-- –î—É—ç–ª—å —Å —Å—Ç–∞–≤–∫–æ–π 100 –∫–æ–∏–Ω–æ–≤
INSERT INTO duels (chat_id, inviter_id, opponent_id, winner_id, stake)
VALUES (-1001234567890, 111111, 222222, 111111, 100);

-- –î—É—ç–ª—å —Å —Å—Ç–∞–≤–∫–æ–π 50 –∫–æ–∏–Ω–æ–≤
INSERT INTO duels (chat_id, inviter_id, opponent_id, winner_id, stake)
VALUES (-1001234567890, 333333, 444444, 444444, 50);
</code></pre>

<hr />
<h2>üéØ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</h2>
<h3>cubes_handler()</h3>
<p><strong>–û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏—è –¥—É—ç–ª–∏.</strong></p>
<pre class="codehilite"><code class="language-python">@dp.message_handler(Text(startswith=['! –∫—É–±—ã', '!–∫—É–±—ã'], ignore_case=True))
async def cubes_handler(message: types.Message):
    &quot;&quot;&quot;
    –ò–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –¥—É—ç–ª—å –º–µ–∂–¥—É –ø—Ä–∏–≥–ª–∞—à–∞—é—â–∏–º –∏ –≤—ã–∑–≤–∞–Ω–Ω—ã–º –∏–≥—Ä–æ–∫–æ–º
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ç–∞–≤–∫–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫—É –±–∞–ª–∞–Ω—Å–∞
    &quot;&quot;&quot;
</code></pre>

<p><strong>–î–µ–π—Å—Ç–≤–∏—è:</strong>
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –¥—É—ç–ª—å –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∞ –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
2. –ü–æ–ª—É—á–∞–µ—Ç —Ü–µ–ª–µ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
3. –ü–∞—Ä—Å–∏—Ç —Ä–∞–∑–º–µ—Ä —Å—Ç–∞–≤–∫–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∫–æ–º–∞–Ω–¥—ã
4. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å –æ–±–æ–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
5. –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é –¥—É—ç–ª—å
6. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
7. –ñ–¥—ë—Ç 90 —Å–µ–∫—É–Ω–¥ –Ω–∞ –æ—Ç–≤–µ—Ç</p>
<h3>accept_duel_handler()</h3>
<p><strong>–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ–≥–ª–∞—Å–∏—è —Å –¥—É—ç–ª—å—é.</strong></p>
<pre class="codehilite"><code class="language-python">@dp.callback_query_handler(lambda call: call.data.startswith('duel_accept_'))
async def accept_duel_handler(call: types.CallbackQuery):
    &quot;&quot;&quot;
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ &quot;–°–æ–≥–ª–∞—Å–∏—Ç—å—Å—è&quot;
    –ü—Ä–æ–≤–æ–¥–∏—Ç —Ä–æ–∑—ã–≥—Ä—ã—à –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
    &quot;&quot;&quot;
</code></pre>

<p><strong>–î–µ–π—Å—Ç–≤–∏—è:</strong>
1. –ü–æ–ª—É—á–∞–µ—Ç ID –¥—É—ç–ª–∏ –∏–∑ callback data
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ –∏—Å—Ç–µ–∫–ª–∞ –ª–∏ –¥—É—ç–ª—å
3. –ü—Ä–æ–≤–æ–¥–∏—Ç –±—Ä–æ—Å–∫–∏ –∫—É–±–∏–∫–æ–≤ –¥–ª—è –æ–±–æ–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
4. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–±–µ–¥–∏—Ç–µ–ª—è (–±–æ–ª—å—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç)
5. –ü–µ—Ä–µ–¥–∞—ë—Ç –∫–æ–∏–Ω—ã –æ—Ç –ø—Ä–æ–∏–≥—Ä–∞–≤—à–µ–≥–æ –∫ –ø–æ–±–µ–¥–∏—Ç–µ–ª—é
6. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
7. –£–¥–∞–ª—è–µ—Ç –¥—É—ç–ª—å –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞</p>
<h3>reject_duel_handler()</h3>
<p><strong>–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –¥—É—ç–ª–∏.</strong></p>
<pre class="codehilite"><code class="language-python">@dp.callback_query_handler(lambda call: call.data.startswith('duel_reject_'))
async def reject_duel_handler(call: types.CallbackQuery):
    &quot;&quot;&quot;
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ &quot;–û—Ç–∫–∞–∑–∞—Ç—å—Å—è&quot;
    &quot;&quot;&quot;
</code></pre>

<p><strong>–î–µ–π—Å—Ç–≤–∏—è:</strong>
1. –£–¥–∞–ª—è–µ—Ç –¥—É—ç–ª—å –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–∫–∞–∑–µ
3. –£–≤–µ–¥–æ–º–ª—è–µ—Ç –ø—Ä–∏–≥–ª–∞—à–∞—é—â–µ–≥–æ –æ–± –æ—Ç–∫–∞–∑–µ</p>
<hr />
<h2>üíª –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</h2>
<h3>–ü—Ä–∏–º–µ—Ä 1: –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏–µ –¥—É—ç–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ</h3>
<pre class="codehilite"><code class="language-python">import asyncio
from dataclasses import dataclass
import time

@dataclass
class _CubesDuel:
    duel_id: str
    chat_id: int
    inviter_id: int
    opponent_id: int
    inviter_name: str
    opponent_name: str
    invite_message_id: int
    created_at: float
    stake: int

async def initiate_duel(inviter_id: int, opponent_id: int, chat_id: int, stake: int = 100):
    &quot;&quot;&quot;–ò–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –¥—É—ç–ª—å –º–µ–∂–¥—É –¥–≤—É–º—è –∏–≥—Ä–æ–∫–∞–º–∏&quot;&quot;&quot;
    import secrets

    duel_id = secrets.token_hex(4)

    duel = _CubesDuel(
        duel_id=duel_id,
        chat_id=chat_id,
        inviter_id=inviter_id,
        opponent_id=opponent_id,
        inviter_name=&quot;Player1&quot;,
        opponent_name=&quot;Player2&quot;,
        invite_message_id=0,
        created_at=time.monotonic(),
        stake=stake
    )

    return duel
</code></pre>

<h3>–ü—Ä–∏–º–µ—Ä 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–æ–≤ –¥–ª—è –¥—É—ç–ª–∏</h3>
<pre class="codehilite"><code class="language-python">def can_both_afford_duel(inviter_id: int, opponent_id: int, stake: int, db_path: str) -&gt; tuple[bool, str]:
    &quot;&quot;&quot;–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–≥—É—Ç –ª–∏ –æ–±–∞ –∏–≥—Ä–æ–∫–∞ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –¥—É—ç–ª–∏&quot;&quot;&quot;
    connection = sqlite3.connect(db_path, check_same_thread=False)
    cursor = connection.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –ø—Ä–∏–≥–ª–∞—à–∞—é—â–µ–≥–æ
    inviter_balance = cursor.execute(
        &quot;SELECT meshok FROM farma WHERE user_id = ?&quot;, 
        (inviter_id,)
    ).fetchone()
    inviter_balance = inviter_balance[0] if inviter_balance else 0

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –≤—ã–∑–≤–∞–Ω–Ω–æ–≥–æ
    opponent_balance = cursor.execute(
        &quot;SELECT meshok FROM farma WHERE user_id = ?&quot;, 
        (opponent_id,)
    ).fetchone()
    opponent_balance = opponent_balance[0] if opponent_balance else 0

    connection.close()

    if inviter_balance &lt; stake:
        return False, f&quot;–£ –ø—Ä–∏–≥–ª–∞—à–∞—é—â–µ–≥–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤ ({inviter_balance}/{stake})&quot;

    if opponent_balance &lt; stake:
        return False, f&quot;–£ –≤—ã–∑–≤–∞–Ω–Ω–æ–≥–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤ ({opponent_balance}/{stake})&quot;

    return True, &quot;–û–±–∞ –∏–≥—Ä–æ–∫–∞ –º–æ–≥—É—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å&quot;

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
can_afford, message = can_both_afford_duel(123456, 234567, 100, &quot;Base_bot.db&quot;)
if can_afford:
    print(&quot;–î—É—ç–ª—å –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å—Å—è&quot;)
else:
    print(f&quot;–û—à–∏–±–∫–∞: {message}&quot;)
</code></pre>

<h3>–ü—Ä–∏–º–µ—Ä 3: –ë—Ä–æ—Å–∫–∏ –∫—É–±–∏–∫–æ–≤ –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è</h3>
<pre class="codehilite"><code class="language-python">import random

def roll_dice() -&gt; int:
    &quot;&quot;&quot;–ë—Ä–æ—Å–∞–µ—Ç –æ–¥–∏–Ω –∫—É–±–∏–∫ (–æ—Ç 1 –¥–æ 6)&quot;&quot;&quot;
    return random.randint(1, 6)

def conduct_duel(inviter_name: str, opponent_name: str, stake: int) -&gt; dict:
    &quot;&quot;&quot;–ü—Ä–æ–≤–æ–¥–∏—Ç –¥—É—ç–ª—å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã&quot;&quot;&quot;
    # –û–±–∞ –∏–≥—Ä–æ–∫–∞ –±—Ä–æ—Å–∞—é—Ç 3 –∫—É–±–∏–∫–∞ –∫–∞–∂–¥—ã–π
    inviter_rolls = [roll_dice() for _ in range(3)]
    opponent_rolls = [roll_dice() for _ in range(3)]

    inviter_score = sum(inviter_rolls)
    opponent_score = sum(opponent_rolls)

    if inviter_score &gt; opponent_score:
        winner = inviter_name
        loser = opponent_name
    elif opponent_score &gt; inviter_score:
        winner = opponent_name
        loser = inviter_name
    else:
        winner = &quot;–ù–∏—á—å—è&quot;
        loser = None

    return {
        &quot;inviter_name&quot;: inviter_name,
        &quot;opponent_name&quot;: opponent_name,
        &quot;inviter_rolls&quot;: inviter_rolls,
        &quot;opponent_rolls&quot;: opponent_rolls,
        &quot;inviter_score&quot;: inviter_score,
        &quot;opponent_score&quot;: opponent_score,
        &quot;winner&quot;: winner,
        &quot;stake&quot;: stake
    }

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
result = conduct_duel(&quot;–ò–≤–∞–Ω&quot;, &quot;–ú–∞—Ä–∏—è&quot;, 100)
print(f&quot;{result['inviter_name']}: {result['inviter_rolls']} = {result['inviter_score']}&quot;)
print(f&quot;{result['opponent_name']}: {result['opponent_rolls']} = {result['opponent_score']}&quot;)
print(f&quot;–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: {result['winner']}&quot;)
</code></pre>

<h3>–ü—Ä–∏–º–µ—Ä 4: –ü–µ—Ä–µ–¥–∞—á–∞ –∫–æ–∏–Ω–æ–≤ –ø–æ—Å–ª–µ –¥—É—ç–ª–∏</h3>
<pre class="codehilite"><code class="language-python">def transfer_coins(from_user: int, to_user: int, amount: int, db_path: str) -&gt; bool:
    &quot;&quot;&quot;–ü–µ—Ä–µ–¥–∞—ë—Ç –∫–æ–∏–Ω—ã –æ—Ç –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥—Ä—É–≥–æ–º—É&quot;&quot;&quot;
    connection = sqlite3.connect(db_path, check_same_thread=False)
    cursor = connection.cursor()

    try:
        # –í—ã—á–∏—Ç–∞–µ–º —É –ø–µ—Ä–≤–æ–≥–æ
        from_balance = cursor.execute(
            &quot;SELECT meshok FROM farma WHERE user_id = ?&quot;,
            (from_user,)
        ).fetchone()

        if from_balance is None or from_balance[0] &lt; amount:
            return False

        new_from_balance = from_balance[0] - amount
        cursor.execute(
            &quot;UPDATE farma SET meshok = ? WHERE user_id = ?&quot;,
            (new_from_balance, from_user)
        )

        # –î–æ–±–∞–≤–ª—è–µ–º –≤—Ç–æ—Ä–æ–º—É
        to_balance = cursor.execute(
            &quot;SELECT meshok FROM farma WHERE user_id = ?&quot;,
            (to_user,)
        ).fetchone()

        new_to_balance = (to_balance[0] if to_balance else 0) + amount

        if to_balance is None:
            cursor.execute(
                &quot;INSERT INTO farma (user_id, meshok, last_date) VALUES (?, ?, ?)&quot;,
                (to_user, new_to_balance, datetime.now().strftime(&quot;%H:%M:%S %d.%m.%Y&quot;))
            )
        else:
            cursor.execute(
                &quot;UPDATE farma SET meshok = ? WHERE user_id = ?&quot;,
                (new_to_balance, to_user)
            )

        connection.commit()
        return True
    except Exception as e:
        print(f&quot;–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –∫–æ–∏–Ω–æ–≤: {e}&quot;)
        return False
    finally:
        connection.close()

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
if transfer_coins(123456, 234567, 100, &quot;Base_bot.db&quot;):
    print(&quot;‚úÖ 100 –∫–æ–∏–Ω–æ–≤ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω—ã&quot;)
else:
    print(&quot;‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –∫–æ–∏–Ω–æ–≤&quot;)
</code></pre>

<h3>–ü—Ä–∏–º–µ—Ä 5: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥—É—ç–ª–∏</h3>
<pre class="codehilite"><code class="language-python">def save_duel_result(chat_id: int, inviter_id: int, opponent_id: int, 
                     winner_id: int, stake: int, db_path: str) -&gt; bool:
    &quot;&quot;&quot;–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥—É—ç–ª–∏ –≤ –ë–î –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏&quot;&quot;&quot;
    connection = sqlite3.connect(db_path, check_same_thread=False)
    cursor = connection.cursor()

    try:
        # –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS duels (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                chat_id INTEGER NOT NULL,
                inviter_id INTEGER NOT NULL,
                opponent_id INTEGER NOT NULL,
                winner_id INTEGER NOT NULL,
                stake INTEGER NOT NULL,
                timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        cursor.execute(
            '''INSERT INTO duels (chat_id, inviter_id, opponent_id, winner_id, stake)
               VALUES (?, ?, ?, ?, ?)''',
            (chat_id, inviter_id, opponent_id, winner_id, stake)
        )

        connection.commit()
        return True
    except Exception as e:
        print(f&quot;–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥—É—ç–ª–∏: {e}&quot;)
        return False
    finally:
        connection.close()

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
save_duel_result(
    chat_id=-1001234567890,
    inviter_id=123456,
    opponent_id=234567,
    winner_id=123456,
    stake=100,
    db_path=&quot;Base_bot.db&quot;
)
</code></pre>

<hr />
<h2>üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è</h2>
<h3>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ main_bot.py</h3>
<pre class="codehilite"><code class="language-python"># main/main_bot.py

import modules.cubes  # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

# –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞...

if __name__ == '__main__':
    print(&quot;Starting bot...&quot;)
    dp.start_polling()
</code></pre>

<h3>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–æ–¥—É–ª–µ–º Farm</h3>
<pre class="codehilite"><code class="language-python"># –°–∏—Å—Ç–µ–º–∞ –¥—É—ç–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–∏–Ω—ã –∏–∑ –º–æ–¥—É–ª—è farm
# –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –¥—É—ç–ª–∏:
# 1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å –≤ —Ç–∞–±–ª–∏—Ü–µ farma
# 2. –í—ã—á–∏—Ç–∞—é—Ç—Å—è –∫–æ–∏–Ω—ã —Å–æ —Å—Ç–∞–≤–∫–æ–π
# 3. –î–æ–±–∞–≤–ª—è—é—Ç—Å—è –∫–æ–∏–Ω—ã –ø–æ–±–µ–¥–∏—Ç–µ–ª—é
</code></pre>

<hr />
<h2>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
<h3>–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤</h3>
<pre class="codehilite"><code class="language-bash">python test_cubes.py
</code></pre>

<h3>–ù–∞–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤</h3>
<pre class="codehilite"><code class="language-python">import unittest
import sqlite3
from datetime import datetime
from pathlib import Path

class TestCubes(unittest.TestCase):
    def setUp(self):
        &quot;&quot;&quot;–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∫–∞–∂–¥–æ–º—É —Ç–µ—Å—Ç—É&quot;&quot;&quot;
        self.test_db = Path(__file__).parent / 'test_cubes.db'
        self.connection = sqlite3.connect(str(self.test_db), check_same_thread=False)
        self.cursor = self.connection.cursor()
        self._create_tables()

    def tearDown(self):
        &quot;&quot;&quot;–û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞&quot;&quot;&quot;
        self.connection.close()
        if self.test_db.exists():
            self.test_db.unlink()

    def _create_tables(self):
        &quot;&quot;&quot;–°–æ–∑–¥–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã&quot;&quot;&quot;
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS farma (
                user_id INTEGER PRIMARY KEY,
                meshok INTEGER DEFAULT 0,
                last_date TEXT
            )
        ''')
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS duels (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                chat_id INTEGER,
                inviter_id INTEGER,
                opponent_id INTEGER,
                winner_id INTEGER,
                stake INTEGER,
                timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        self.connection.commit()

    def test_duel_requires_sufficient_balance(self):
        &quot;&quot;&quot;–¢–µ—Å—Ç: –¥—É—ç–ª—å —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞&quot;&quot;&quot;
        # –ü–µ—Ä–≤—ã–π –∏–≥—Ä–æ–∫ —Å 50 –∫–æ–∏–Ω–∞–º–∏
        self.cursor.execute(
            &quot;INSERT INTO farma (user_id, meshok, last_date) VALUES (?, ?, ?)&quot;,
            (123456, 50, datetime.now().strftime(&quot;%H:%M:%S %d.%m.%Y&quot;))
        )

        # –í—Ç–æ—Ä–æ–π –∏–≥—Ä–æ–∫ —Å 200 –∫–æ–∏–Ω–∞–º–∏
        self.cursor.execute(
            &quot;INSERT INTO farma (user_id, meshok, last_date) VALUES (?, ?, ?)&quot;,
            (234567, 200, datetime.now().strftime(&quot;%H:%M:%S %d.%m.%Y&quot;))
        )
        self.connection.commit()

        # –ü–µ—Ä–≤—ã–π –Ω–µ –º–æ–∂–µ—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –¥—É—ç–ª–∏ –Ω–∞ 100 –∫–æ–∏–Ω–æ–≤
        balance1 = self.cursor.execute(
            &quot;SELECT meshok FROM farma WHERE user_id = ?&quot;,
            (123456,)
        ).fetchone()[0]

        stake = 100
        self.assertLess(balance1, stake)

if __name__ == '__main__':
    unittest.main()
</code></pre>

<hr />
<h2>üöÄ –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏</h2>
<h3>–ò–¥–µ—è 1: –†–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –¥—É—ç–ª–µ–π</h3>
<pre class="codehilite"><code class="language-python">DUEL_TYPES = {
    &quot;—Å—Ç–∞–Ω–¥–∞—Ä—Ç&quot;: {&quot;dice_count&quot;: 3, &quot;name&quot;: &quot;–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –¥—É—ç–ª—å&quot;},
    &quot;—ç–∫—Å—Ç—Ä–∏–º&quot;: {&quot;dice_count&quot;: 5, &quot;name&quot;: &quot;–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞—è –¥—É—ç–ª—å&quot;},
    &quot;–±—ã—Å—Ç—Ä–∞—è&quot;: {&quot;dice_count&quot;: 1, &quot;name&quot;: &quot;–ë—ã—Å—Ç—Ä–∞—è –¥—É—ç–ª—å&quot;}
}

def get_duel_type_info(duel_type: str) -&gt; dict:
    &quot;&quot;&quot;–ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∏–ø–µ –¥—É—ç–ª–∏&quot;&quot;&quot;
    return DUEL_TYPES.get(duel_type, DUEL_TYPES[&quot;—Å—Ç–∞–Ω–¥–∞—Ä—Ç&quot;])
</code></pre>

<h3>–ò–¥–µ—è 2: –†–µ–π—Ç–∏–Ω–≥ –¥—É—ç–ª–∏—Å—Ç–æ–≤</h3>
<pre class="codehilite"><code class="language-python">def get_duel_stats(user_id: int, db_path: str) -&gt; dict:
    &quot;&quot;&quot;–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –¥—É—ç–ª—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è&quot;&quot;&quot;
    connection = sqlite3.connect(db_path, check_same_thread=False)
    cursor = connection.cursor()

    # –í—Å–µ–≥–æ –¥—É—ç–ª–µ–π
    total = cursor.execute(
        &quot;SELECT COUNT(*) FROM duels WHERE inviter_id = ? OR opponent_id = ?&quot;,
        (user_id, user_id)
    ).fetchone()[0]

    # –ü–æ–±–µ–¥
    wins = cursor.execute(
        &quot;SELECT COUNT(*) FROM duels WHERE winner_id = ?&quot;,
        (user_id,)
    ).fetchone()[0]

    # –ü—Ä–æ–∏–≥—Ä—ã—à–µ–π
    losses = total - wins

    # –í—ã–∏–≥—Ä–∞–Ω–Ω—ã—Ö –∫–æ–∏–Ω–æ–≤
    earned = cursor.execute(
        &quot;SELECT SUM(stake) FROM duels WHERE winner_id = ?&quot;,
        (user_id,)
    ).fetchone()[0] or 0

    connection.close()

    return {
        &quot;total_duels&quot;: total,
        &quot;wins&quot;: wins,
        &quot;losses&quot;: losses,
        &quot;win_rate&quot;: (wins / total * 100) if total &gt; 0 else 0,
        &quot;earned_coins&quot;: earned
    }
</code></pre>

<h3>–ò–¥–µ—è 3: –°–µ–∑–æ–Ω–Ω—ã–µ —Ç—É—Ä–Ω–∏—Ä—ã –¥—É—ç–ª–µ–π</h3>
<pre class="codehilite"><code class="language-python">def get_season_stats(user_id: int, season: str, db_path: str) -&gt; dict:
    &quot;&quot;&quot;–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞ —Å–µ–∑–æ–Ω&quot;&quot;&quot;
    connection = sqlite3.connect(db_path, check_same_thread=False)
    cursor = connection.cursor()

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—ã —Å–µ–∑–æ–Ω–∞
    season_dates = {
        &quot;S1_2025&quot;: (&quot;2025-01-01&quot;, &quot;2025-03-31&quot;),
        &quot;S2_2025&quot;: (&quot;2025-04-01&quot;, &quot;2025-06-30&quot;),
        &quot;S3_2025&quot;: (&quot;2025-07-01&quot;, &quot;2025-09-30&quot;),
        &quot;S4_2025&quot;: (&quot;2025-10-01&quot;, &quot;2025-12-31&quot;),
    }

    if season not in season_dates:
        return {}

    start_date, end_date = season_dates[season]

    wins = cursor.execute(
        &quot;SELECT COUNT(*) FROM duels WHERE winner_id = ? AND timestamp BETWEEN ? AND ?&quot;,
        (user_id, start_date, end_date)
    ).fetchone()[0]

    connection.close()
    return {&quot;season&quot;: season, &quot;wins&quot;: wins}
</code></pre>

<hr />
<h2>üìù –õ–∏—Ü–µ–Ω–∑–∏—è</h2>
<p>–ß–∞—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞ WERTY | Chat-Manager Bot</p>
<hr />
<p><strong>–í–µ—Ä—Å–∏—è:</strong> 1.0<br />
<strong>–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ:</strong> GitHub Copilot<br />
<strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</strong> 20.12.2025</p>
        </div>

        <div class="content">
            <div class="nav-buttons">
                <a href="../html/index_site.html" class="nav-button prev">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏</a>
                <a href="../html/index.html" class="nav-button">–ù–∞ –≥–ª–∞–≤–Ω—É—é ‚Üí</a>
            </div>
        </div>

        <footer>
            <p>Chat Manager Bot | –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ | –í–µ—Ä—Å–∏—è 2.0</p>
            <p style="margin-top: 10px;">
                <a href="../html/index.html">–ì–ª–∞–≤–Ω–∞—è</a> | 
                <a href="../html/index_site.html">–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</a> | 
                <a href="../html/modules.html">–ú–æ–¥—É–ª–∏</a>
            </p>
        </footer>
    </div>
</body>
</html>
